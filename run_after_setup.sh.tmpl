#!/usr/bin/env bash
set -euo pipefail

# ======================================================
# macOS → Homebrew + Brewfiles
# ======================================================
{{- if eq .chezmoi.os "darwin" }}

if ! command -v brew >/dev/null 2>&1; then
  echo "Installing Homebrew..."
  NONINTERACTIVE=1 /bin/bash -c \
    "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

eval "$(/opt/homebrew/bin/brew shellenv)"

brew bundle --file "$HOME/Brewfile" --no-upgrade

if [[ -f "$HOME/Brewfile.darwin" ]]; then
  brew bundle --file "$HOME/Brewfile.darwin" --no-upgrade
fi

if [[ ! -d "$HOME/nvim-macos-arm64" ]]; then
  # install nightly nvim
  curl -L -o ~/nvim-macos-arm64 https://github.com/neovim/neovim/releases/download/nightly/nvim-macos-arm64.tar.gz
  tar -xf ~/nvim-macos-arm64.tar.gz -C ~/
fi

# ======================================================
# Setup docker
# ======================================================
# Create CLI plugin directory
mkdir -p ~/.docker/cli-plugins

# Symlink Docker plugins (allows 'docker compose' and 'docker buildx' to work)
# We use 'ln -sfn' to overwrite any existing broken links/files
if command -v brew >/dev/null 2>&1; then
  BREW_PREFIX=$(brew --prefix)
  ln -sfn "$BREW_PREFIX/opt/docker-compose/bin/docker-compose" ~/.docker/cli-plugins/docker-compose
  ln -sfn "$BREW_PREFIX/opt/docker-buildx/bin/docker-buildx" ~/.docker/cli-plugins/docker-buildx
fi

{{- end }}

# ======================================================
# Linux NON-RDEV → Homebrew + Brewfiles
# ======================================================
{{- if and (eq .chezmoi.os "linux")
          (not (and (contains "rdev" (env "RDEV_ID"))
                    (eq "coder" .chezmoi.username)
                    (eq "/home/coder" .chezmoi.homeDir))) }}

if ! command -v brew >/dev/null 2>&1; then
  echo "Installing Linuxbrew..."
  # Ensure Linuxbrew prefix exists and is user-owned
  if [[ ! -d /home/linuxbrew ]]; then
    echo "Creating /home/linuxbrew (requires sudo once)..."
    sudo mkdir -p /home/linuxbrew
  fi

  NONINTERACTIVE=1 /bin/bash -c \
    "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"

brew bundle --file "$HOME/Brewfile" --no-upgrade

if [[ -f "$HOME/Brewfile.linux" ]]; then
  brew bundle --file "$HOME/Brewfile.linux" --no-upgrade
fi

# ======================================================
# Setup docker
# ======================================================
if ! command -v docker >/dev/null 2>&1; then
  if [[ -f "$HOME/docker_install_linux.sh" ]]; then
    echo "Docker not found. Running installation script..."
    bash "$HOME/docker_install_linux.sh"
  else
    echo "Warning: ~/docker_install_linux.sh not found. Skipping Docker install."
  fi
fi

# ======================================================
# Install Neovim Nightly
# ======================================================
if [[ ! -d "$HOME/nvim-linux-x86_64" ]]; then
  # install nightly nvim
  curl -L -o ~/nvim-linux.tar.gz https://github.com/neovim/neovim/releases/download/nightly/nvim-linux-x86_64.tar.gz
  tar -xf ~/nvim-linux.tar.gz -C ~/
fi

{{- end }}

# ======================================================
# Linux RDEV → Pixi ONLY (no Homebrew)
# ======================================================
{{- if and (eq .chezmoi.os "linux")
          (contains "rdev" (env "RDEV_ID"))
          (eq "coder" .chezmoi.username)
          (eq "/home/coder" .chezmoi.homeDir) }}

install_pixi() {
  if [[ ! -d "$HOME/.pixi" ]]; then
    curl -fsSL https://pixi.sh/install.sh | bash || {
      mkdir -p "$HOME/.pixi/bin"
      curl -L -o "$HOME/.pixi/bin/pixi" \
        https://github.com/prefix-dev/pixi/releases/download/v0.40.3/pixi-x86_64-unknown-linux-musl
      chmod +x "$HOME/.pixi/bin/pixi"
    }
  fi
}

install_pixi

base_packages=(
  bat
  direnv
  eza
  fd-find
  fzf
  jq
  lua
  luajit
  luarocks
  nodejs
  nvim
  ripgrep
  ripgrep-all
  sd
  sqlite
  tealdeer
  yq
  zoxide
)

"$HOME/.pixi/bin/pixi" global install "${base_packages[@]}"

{{- end }}

# ======================================================
# Neovim Python provider (unchanged)
# ======================================================
if [[ ! -d "$HOME/.nvim-env" ]]; then
  if [[ -f /export/apps/python/3.12/bin/python3 ]]; then
    /export/apps/python/3.12/bin/python3 -m venv "$HOME/.nvim-env"
    "$HOME/.nvim-env/bin/python" -m pip install neovim
  fi
fi

